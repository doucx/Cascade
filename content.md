我们确实正在面对大量由存根生成器（Stub Generator）引起的 lint 错误。这些错误主要源于生成的 `.pyi` 文件中缺少 `typing` 模块的导入，以及生成的导入语句顺序不符合 PEP 8 规范。

修复这些问题将为你提供一个干净的开发环境，并消除 IDE 中的红色波浪线。

## [WIP] fix(tooling): 修复 stub 生成器的导入缺失与顺序问题

### 错误分析
1.  **`F821 Undefined name 'typing'`**:
    *   **原因**: `scripts/generate_stubs.py` 使用 `inspect` 模块提取函数签名。`inspect` 经常返回包含 `typing.` 前缀的类型注解（如 `typing.Dict`），但生成的 `.pyi` 文件头只导入了 `Dict`、`List` 等具体类型，而没有导入 `typing` 模块本身。
2.  **`E402 Module level import not at top of file`**:
    *   **原因**: `scripts/generate_stubs.py` 在生成文件内容时，先追加了函数定义 (`pyi_providers`)，然后才追加子模块的重导出语句 (`pyi_namespaces`)。这导致 `from . import fs as fs` 出现在文件底部，违反了导入置顶的规则。
3.  **`cicd/workflows.py` 的 E402**:
    *   **原因**: 该文件中的 `import os` 语句位置不正确。

### 用户需求
1.  修正 `scripts/generate_stubs.py`，使其生成的 `.pyi` 文件包含 `import typing`。
2.  调整生成逻辑，确保命名空间的重导出语句（Import）位于函数定义之前。
3.  修复 `cicd/workflows.py` 中的导入顺序问题。
4.  重新生成所有存根并验证通过。

### 评论
这是一个典型的“工具链维护”任务。虽然不涉及核心运行时逻辑，但修复它对于开发者体验（DX）至关重要。如果不修复，真实的类型错误将被这些噪音淹没。

### 目标
1.  消除所有 `F821` 和 `E402` 错误。
2.  确保 `scripts/generate_stubs.py` 生成符合规范的 Python 代码。

### 基本原理
通过修改生成器脚本而不是手动修改生成的 `.pyi` 文件，我们保证了未来的更新也能自动遵循正确的规范。在 `.pyi` 文件中，虽然 Python 允许灵活的顺序，但为了兼容 `ruff` 和其他工具，保持“Imports -> Exports -> Definitions”的顺序是最佳实践。

### 标签
#intent/fix #flow/ready #priority/high #comp/build #scope/dx #ai/instruct #task/domain/tooling #task/object/ide-stubs #task/action/fix #task/state/continue

---

### Script

#### Acts 1: 修复 `cicd/workflows.py` 的导入顺序
首先快速修复这个独立文件的导入位置问题。

~~~~~act
patch_file
cicd/workflows.py
~~~~~
~~~~~python
import cascade as cs
from typing import List
from .tasks import (
    parse_git_diff,
    get_lint_command,
    get_test_command,
    get_build_command,
    get_publish_command,
)

# List of all packages in the monorepo for full runs.
ALL_PACKAGES = [
    "cascade-spec",
    "cascade-common",
    "cascade-graph",
    "cascade-engine",
    "cascade-sdk",
    "cascade-library",
    "cascade-connector-local",
    "cascade-connector-mqtt",
    "cascade-cli-controller",
    "cascade-cli-observer",
    "cascade-provider-ipfs",
]


@cs.task
def _ci_success_marker(results: List[str]):
    """A dummy task to act as a final success node in the graph."""
    print("CI checks completed successfully.")
    print("Results:", results)
    return "CI_SUCCESS"


import os
~~~~~
~~~~~python
import os
import cascade as cs
from typing import List
from .tasks import (
    parse_git_diff,
    get_lint_command,
    get_test_command,
    get_build_command,
    get_publish_command,
)

# List of all packages in the monorepo for full runs.
ALL_PACKAGES = [
    "cascade-spec",
    "cascade-common",
    "cascade-graph",
    "cascade-engine",
    "cascade-sdk",
    "cascade-library",
    "cascade-connector-local",
    "cascade-connector-mqtt",
    "cascade-cli-controller",
    "cascade-cli-observer",
    "cascade-provider-ipfs",
]


@cs.task
def _ci_success_marker(results: List[str]):
    """A dummy task to act as a final success node in the graph."""
    print("CI checks completed successfully.")
    print("Results:", results)
    return "CI_SUCCESS"
~~~~~

~~~~~act
patch_file
cicd/workflows.py
~~~~~
~~~~~python


import os
~~~~~
~~~~~python

~~~~~

#### Acts 2: 修正 `generate_stubs.py` 的生成逻辑
我们将修改 `_generate_level` 函数：
1.  在头部添加 `import typing`。
2.  调整 `content_lines.extend` 的顺序，先处理 `pyi_namespaces`，再处理 `pyi_providers`。

~~~~~act
patch_file
scripts/generate_stubs.py
~~~~~
~~~~~python
    content_lines = [
        "# This file is auto-generated by scripts/generate_stubs.py.",
        "# Do not edit this file directly.",
        "from typing import Any, Callable, Dict, List, Optional, Union",
        "from cascade.spec.lazy_types import LazyResult",
        "from cascade.spec.protocols import Connector, StateBackend, CachePolicy",
    ]

    pyi_providers = []
    pyi_namespaces = []

    if is_root:
~~~~~
~~~~~python
    content_lines = [
        "# This file is auto-generated by scripts/generate_stubs.py.",
        "# Do not edit this file directly.",
        "import typing",
        "from typing import Any, Callable, Dict, List, Optional, Union",
        "from cascade.spec.lazy_types import LazyResult",
        "from cascade.spec.protocols import Connector, StateBackend, CachePolicy",
    ]

    pyi_providers = []
    pyi_namespaces = []

    if is_root:
~~~~~

~~~~~act
patch_file
scripts/generate_stubs.py
~~~~~
~~~~~python
            if sig_info:
                sig_str, doc_str = sig_info
                if doc_str:
                    provider_def = f"def {name}{sig_str}:\n{doc_str}"
                else:
                    provider_def = f"def {name}{sig_str}: ..."
                pyi_providers.append(provider_def)

    if pyi_providers:
        content_lines.extend(pyi_providers)

    if pyi_namespaces:
        if pyi_providers:
            content_lines.append("")
        content_lines.extend(
            f"from . import {name} as {name}" for name in pyi_namespaces
        )

    content = "\n".join(content_lines)
~~~~~
~~~~~python
            if sig_info:
                sig_str, doc_str = sig_info
                if doc_str:
                    provider_def = f"def {name}{sig_str}:\n{doc_str}"
                else:
                    provider_def = f"def {name}{sig_str}: ..."
                pyi_providers.append(provider_def)

    # Re-exports (Namespaces) come first to satisfy E402
    if pyi_namespaces:
        content_lines.extend(
            f"from . import {name} as {name}" for name in pyi_namespaces
        )
        if pyi_providers:
            content_lines.append("")

    # Provider definitions come next
    if pyi_providers:
        content_lines.extend(pyi_providers)

    content = "\n".join(content_lines)
~~~~~

### 下一步建议
一旦 Lint 错误清除，我们将获得一个干净的基线。接下来，可以像你提到的那样，关注 `LazyResult` 的泛型支持，进一步提升 IDE 的智能提示能力。
